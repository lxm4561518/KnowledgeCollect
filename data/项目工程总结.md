# 知识收藏工程总结

## 项目概述
- 目标：在知乎、B站、抖音等平台存在风控与登录墙的前提下，稳定地采集网页正文，持久化输出为 Markdown，并为后续摘要与知识库沉淀打基础。
- 现状：实现了知乎在登录一次后长期复用会话、自动检测并绕过“安全验证/40362”场景、多通道抓取与降级策略、以及产物落盘与仓库管理。

## 关键技术
- 持久化会话与交互模式：通过 `launch_persistent_context` 复用登录态，必要时进入交互模式，检测登录完成后自动继续采集（`src/collectors/browser_fetcher.py:68-76, 119-140`）。
- 多通道抓取与降级：优先 `cloudscraper`；失败后走 `requests + cookies`；再失败触发浏览器交互模式重试（`src/collectors/zhihu.py:65-82, 118-123`）。
- Cookies 管理：优先读取 `data/cookies/zhihu.json`；权限受限时复制 Edge Cookie 数据库到临时文件再读；必要时用浏览器导出 Cookies（`src/collectors/common.py:77-97, 13-47, 100-111`）。
- 反爬伪装：UA/语言/Referer 伪装、禁用 `navigator.webdriver` 暴露、随机鼠标与滚动（`src/collectors/browser_fetcher.py:84-96, 104-116`）。
- UC 驱动版本兼容：在本地 Chrome 与 UC 驱动版本不匹配时，强制 `version_main=128` 并降级到默认配置（`src/collectors/browser_fetcher.py:17-27`）。
- 任务编排与写盘：主流程基于 CSV，按来源与 URL 采集后写入 `data/*.md`，支持自定义标题清洗与文件命名（`src/main.py:36-75`）。
- Windows 兼容性：在 Windows 上强制 `ProactorEventLoopPolicy` 保证 Playwright 等同步/异步工具正常工作（`src/main.py:5-8`，`src/collectors/browser_fetcher.py:59-62`）。
- 安全与仓库治理：忽略 `.profiles/` 与 `data/cookies/`，避免隐私与仓库污染；远端移除已跟踪内容并推送（`.gitignore:1-8`）。
- 单元测试与验证：为知乎采集编写集成测试，确保登录态复用与正文提取质量（`tests/test_zhihu_integration.py:1-38`）。

## 解决的问题
- 打通知乎登录墙与风控（40362），在一次登录后实现长期复用登录态，减少重复交互；并在遇到验证时自动保持窗口、检测登录完成后继续采集。
- 在 IP/设备指纹/权限因素导致的 Cookie 读取失败场景下，提供多种回退路径（本地 JSON、复制 Edge 库、浏览器导出），显著提升鲁棒性。
- 在 Cloudflare/反机器人策略下，仍可通过浏览器渲染与人类行为模拟拿到页面正文，规避“标题页但内容为空”或错误 JSON 的误采集。

## 技术难点与解法
- 风控错误 40362 与“安全验证”
  - 难点：请求返回异常页或登录墙，非 4xx/5xx 状态码仍会“成功”但正文为空。
  - 解法：多级检测与重试链路（`cloudscraper` → `requests+cookies` → 浏览器交互）；在交互模式下循环检查标题与页面内容是否去除风控标记，以及是否存在关键登录 Cookie `z_c0`（`src/collectors/browser_fetcher.py:121-133`）。
- Cookie 加载权限受限
  - 难点：直接读取系统浏览器 Cookie 数据库会遇到权限异常。
  - 解法：三层回退——优先读取 `data/cookies/zhihu.json`；若无则复制 Edge Cookie 数据库到临时文件后加载；仍失败则调用浏览器获取 Cookies（`src/collectors/common.py:77-111`）。
- UC 驱动版本不匹配
  - 难点：UC 自动下载驱动版本与本地 Chrome 主版本不一致导致初始化失败。
  - 解法：显式指定 `version_main=128` 并提供降级路径，保证 UC 分支正常工作（`src/collectors/browser_fetcher.py:17-27`）。
- 自动继续与无感采集
  - 难点：交互等待易“卡住”，需要在检测到登录完成时自动继续。
  - 解法：在交互模式下开启最长 600 秒轮询，满足条件立即写盘并导出 Cookies；若仍未成功且设置 `--hold`，可人工完成后继续（`src/collectors/browser_fetcher.py:119-140`）。
- 标题清洗与文件命名
  - 难点：中文标题、空标题或特殊字符导致文件名不可用。
  - 解法：按白名单字符清洗，兜底 `untitled`，写入 `data/*.md`（`src/main.py:61-67`）。
- 仓库隐私与体积控制
  - 难点：持久化会话目录与 Cookies 易污染仓库、暴露隐私。
  - 解法：删除本地 `.profiles`、远端停止跟踪，`.gitignore` 忽略敏感目录（`.gitignore:1-8`）。

## 工作流
- 采集入口：`data/collection.csv`（`source,url,提示词`）。
- 采集执行：`python src/main.py data/collection.csv`，自动检测平台与分支，写入 `data/*.md`。
- 交互与复用：首次登录后持久化目录 `ZHIHU_PROFILE_DIR`（`src/config.py:16-19`）与 `data/cookies/zhihu.json`；后续自动复用。
- 摘要提示词：CSV 新增“提示词”列，用于后续摘要阶段统一结构化输出，并内置 JSON 输出模板（`data/collection.csv:1-5`）。

## 实践价值
- 在真实网络与风控环境下可靠采集网页正文，降低人工复制成本。
- 一次登录、长期复用，大幅降低交互干预频率，提高采集效率。
- 可扩展到更多平台（如需要可添加新的 `collectors/*` 分支），沿用同样的鲁棒链路与安全治理方案。

## 延伸规划
- 接入摘要阶段：读取 CSV 的“提示词”，将 `title/text` 注入 `$json`，自动生成结构化 JSON 摘要落盘。
- 统一测试矩阵：增加对不同类型页面（专栏、问答、视频简介）的采集断言。
- 代理与指纹库：引入稳定代理池与更完善的指纹伪装，提高抗风控能力（如移动 UA/设备模拟、请求节奏控制）。
- 平台同步：将 Markdown 与摘要同步到飞书/企业知识库，形成完整的团队知识沉淀链路。

